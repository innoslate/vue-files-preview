"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const g=require("../../view/dist/index.js"),x=require("../../state/dist/index.js"),b=require("../../../crelt/index.js");class L{constructor(e,n,i){this.from=e,this.to=n,this.diagnostic=i}}class w{constructor(e,n,i){this.diagnostics=e,this.panel=n,this.selected=i}static init(e,n,i){let o=i.facet(v).markerFilter;o&&(e=o(e,i));let s=e.slice().sort((a,h)=>a.from-h.from||a.to-h.to),r=new x.RangeSetBuilder,l=[],d=0;for(let a=0;;){let h=a==s.length?null:s[a];if(!h&&!l.length)break;let f,u;for(l.length?(f=d,u=l.reduce((c,k)=>Math.min(c,k.to),h&&h.from>f?h.from:1e8)):(f=h.from,u=h.to,l.push(h),a++);a<s.length;){let c=s[a];if(c.from==f&&(c.to>c.from||c.to==f))l.push(c),a++,u=Math.min(c.to,u);else{u=Math.min(c.from,u);break}}let I=U(l);if(l.some(c=>c.from==c.to||c.from==c.to-1&&i.doc.lineAt(c.from).to==c.from))r.add(f,f,g.Decoration.widget({widget:new j(I),diagnostics:l.slice()}));else{let c=l.reduce((k,A)=>A.markClass?k+" "+A.markClass:k,"");r.add(f,u,g.Decoration.mark({class:"cm-lintRange cm-lintRange-"+I+c,diagnostics:l.slice(),inclusiveEnd:l.some(k=>k.to>u)}))}d=u;for(let c=0;c<l.length;c++)l[c].to<=d&&l.splice(c--,1)}let m=r.finish();return new w(m,n,y(m))}}function y(t,e=null,n=0){let i=null;return t.between(n,1e9,(o,s,{spec:r})=>{if(!(e&&r.diagnostics.indexOf(e)<0))if(!i)i=new L(o,s,e||r.diagnostics[0]);else{if(r.diagnostics.indexOf(i.diagnostic)<0)return!1;i=new L(i.from,s,i.diagnostic)}}),i}function $(t,e){let n=e.pos,i=e.end||n,o=t.state.facet(v).hideOn(t,n,i);if(o!=null)return o;let s=t.startState.doc.lineAt(e.pos);return!!(t.effects.some(r=>r.is(D))||t.changes.touchesRange(s.from,Math.max(s.to,i)))}function q(t,e){return t.field(p,!1)?e:e.concat(x.StateEffect.appendConfig.of(Y))}const D=x.StateEffect.define(),R=x.StateEffect.define(),M=x.StateEffect.define(),p=x.StateField.define({create(){return new w(g.Decoration.none,null,null)},update(t,e){if(e.docChanged&&t.diagnostics.size){let n=t.diagnostics.map(e.changes),i=null,o=t.panel;if(t.selected){let s=e.changes.mapPos(t.selected.from,1);i=y(n,t.selected.diagnostic,s)||y(n,null,s)}!n.size&&o&&e.state.facet(v).autoPanel&&(o=null),t=new w(n,o,i)}for(let n of e.effects)if(n.is(D)){let i=e.state.facet(v).autoPanel?n.value.length?C.open:null:t.panel;t=w.init(n.value,i,e.state)}else n.is(R)?t=new w(t.diagnostics,n.value?C.open:null,t.selected):n.is(M)&&(t=new w(t.diagnostics,t.panel,n.value));return t},provide:t=>[g.showPanel.from(t,e=>e.panel),g.EditorView.decorations.from(t,e=>e.diagnostics)]}),V=g.Decoration.mark({class:"cm-lintRange cm-lintRange-active"});function z(t,e,n){let{diagnostics:i}=t.state.field(p),o,s=-1,r=-1;i.between(e-(n<0?1:0),e+(n>0?1:0),(d,m,{spec:a})=>{if(e>=d&&e<=m&&(d==m||(e>d||n>0)&&(e<m||n<0)))return o=a.diagnostics,s=d,r=m,!1});let l=t.state.facet(v).tooltipFilter;return o&&l&&(o=l(o,t.state)),o?{pos:s,end:r,above:t.state.doc.lineAt(s).to<r,create(){return{dom:H(t,o)}}}:null}function H(t,e){return b("ul",{class:"cm-tooltip-lint"},e.map(n=>O(t,n,!1)))}const T=t=>{let e=t.state.field(p,!1);(!e||!e.panel)&&t.dispatch({effects:q(t.state,[R.of(!0)])});let n=g.getPanel(t,C.open);return n&&n.dom.querySelector(".cm-panel-lint ul").focus(),!0},P=t=>{let e=t.state.field(p,!1);return!e||!e.panel?!1:(t.dispatch({effects:R.of(!1)}),!0)},B=t=>{let e=t.state.field(p,!1);if(!e)return!1;let n=t.state.selection.main,i=e.diagnostics.iter(n.to+1);return!i.value&&(i=e.diagnostics.iter(0),!i.value||i.from==n.from&&i.to==n.to)?!1:(t.dispatch({selection:{anchor:i.from,head:i.to},scrollIntoView:!0}),!0)},_=[{key:"Mod-Shift-m",run:T,preventDefault:!0},{key:"F8",run:B}],v=x.Facet.define({combine(t){return Object.assign({sources:t.map(e=>e.source).filter(e=>e!=null)},x.combineConfig(t.map(e=>e.config),{delay:750,markerFilter:null,tooltipFilter:null,needsRefresh:null,hideOn:()=>null},{needsRefresh:(e,n)=>e?n?i=>e(i)||n(i):e:n}))}});function F(t){let e=[];if(t)e:for(let{name:n}of t){for(let i=0;i<n.length;i++){let o=n[i];if(/[a-zA-Z]/.test(o)&&!e.some(s=>s.toLowerCase()==o.toLowerCase())){e.push(o);continue e}}e.push("")}return e}function O(t,e,n){var i;let o=n?F(e.actions):[];return b("li",{class:"cm-diagnostic cm-diagnostic-"+e.severity},b("span",{class:"cm-diagnosticText"},e.renderMessage?e.renderMessage(t):e.message),(i=e.actions)===null||i===void 0?void 0:i.map((s,r)=>{let l=!1,d=f=>{if(f.preventDefault(),l)return;l=!0;let u=y(t.state.field(p).diagnostics,e);u&&s.apply(t,u.from,u.to)},{name:m}=s,a=o[r]?m.indexOf(o[r]):-1,h=a<0?m:[m.slice(0,a),b("u",m.slice(a,a+1)),m.slice(a+1)];return b("button",{type:"button",class:"cm-diagnosticAction",onclick:d,onmousedown:d,"aria-label":` Action: ${m}${a<0?"":` (access key "${o[r]})"`}.`},h)}),e.source&&b("div",{class:"cm-diagnosticSource"},e.source))}class j extends g.WidgetType{constructor(e){super(),this.sev=e}eq(e){return e.sev==this.sev}toDOM(){return b("span",{class:"cm-lintPoint cm-lintPoint-"+this.sev})}}class E{constructor(e,n){this.diagnostic=n,this.id="item_"+Math.floor(Math.random()*4294967295).toString(16),this.dom=O(e,n,!0),this.dom.id=this.id,this.dom.setAttribute("role","option")}}class C{constructor(e){this.view=e,this.items=[];let n=o=>{if(o.keyCode==27)P(this.view),this.view.focus();else if(o.keyCode==38||o.keyCode==33)this.moveSelection((this.selectedIndex-1+this.items.length)%this.items.length);else if(o.keyCode==40||o.keyCode==34)this.moveSelection((this.selectedIndex+1)%this.items.length);else if(o.keyCode==36)this.moveSelection(0);else if(o.keyCode==35)this.moveSelection(this.items.length-1);else if(o.keyCode==13)this.view.focus();else if(o.keyCode>=65&&o.keyCode<=90&&this.selectedIndex>=0){let{diagnostic:s}=this.items[this.selectedIndex],r=F(s.actions);for(let l=0;l<r.length;l++)if(r[l].toUpperCase().charCodeAt(0)==o.keyCode){let d=y(this.view.state.field(p).diagnostics,s);d&&s.actions[l].apply(e,d.from,d.to)}}else return;o.preventDefault()},i=o=>{for(let s=0;s<this.items.length;s++)this.items[s].dom.contains(o.target)&&this.moveSelection(s)};this.list=b("ul",{tabIndex:0,role:"listbox","aria-label":this.view.state.phrase("Diagnostics"),onkeydown:n,onclick:i}),this.dom=b("div",{class:"cm-panel-lint"},this.list,b("button",{type:"button",name:"close","aria-label":this.view.state.phrase("close"),onclick:()=>P(this.view)},"Ã—")),this.update()}get selectedIndex(){let e=this.view.state.field(p).selected;if(!e)return-1;for(let n=0;n<this.items.length;n++)if(this.items[n].diagnostic==e.diagnostic)return n;return-1}update(){let{diagnostics:e,selected:n}=this.view.state.field(p),i=0,o=!1,s=null,r=new Set;for(e.between(0,this.view.state.doc.length,(l,d,{spec:m})=>{for(let a of m.diagnostics){if(r.has(a))continue;r.add(a);let h=-1,f;for(let u=i;u<this.items.length;u++)if(this.items[u].diagnostic==a){h=u;break}h<0?(f=new E(this.view,a),this.items.splice(i,0,f),o=!0):(f=this.items[h],h>i&&(this.items.splice(i,h-i),o=!0)),n&&f.diagnostic==n.diagnostic?f.dom.hasAttribute("aria-selected")||(f.dom.setAttribute("aria-selected","true"),s=f):f.dom.hasAttribute("aria-selected")&&f.dom.removeAttribute("aria-selected"),i++}});i<this.items.length&&!(this.items.length==1&&this.items[0].diagnostic.from<0);)o=!0,this.items.pop();this.items.length==0&&(this.items.push(new E(this.view,{from:-1,to:-1,severity:"info",message:this.view.state.phrase("No diagnostics")})),o=!0),s?(this.list.setAttribute("aria-activedescendant",s.id),this.view.requestMeasure({key:this,read:()=>({sel:s.dom.getBoundingClientRect(),panel:this.list.getBoundingClientRect()}),write:({sel:l,panel:d})=>{let m=d.height/this.list.offsetHeight;l.top<d.top?this.list.scrollTop-=(d.top-l.top)/m:l.bottom>d.bottom&&(this.list.scrollTop+=(l.bottom-d.bottom)/m)}})):this.selectedIndex<0&&this.list.removeAttribute("aria-activedescendant"),o&&this.sync()}sync(){let e=this.list.firstChild;function n(){let i=e;e=i.nextSibling,i.remove()}for(let i of this.items)if(i.dom.parentNode==this.list){for(;e!=i.dom;)n();e=i.dom.nextSibling}else this.list.insertBefore(i.dom,e);for(;e;)n()}moveSelection(e){if(this.selectedIndex<0)return;let n=this.view.state.field(p),i=y(n.diagnostics,this.items[e].diagnostic);i&&this.view.dispatch({selection:{anchor:i.from,head:i.to},scrollIntoView:!0,effects:M.of(i)})}static open(e){return new C(e)}}function K(t,e='viewBox="0 0 40 40"'){return`url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" ${e}>${encodeURIComponent(t)}</svg>')`}function S(t){return K(`<path d="m0 2.5 l2 -1.5 l1 0 l2 1.5 l1 0" stroke="${t}" fill="none" stroke-width=".7"/>`,'width="6" height="3"')}const W=g.EditorView.baseTheme({".cm-diagnostic":{padding:"3px 6px 3px 8px",marginLeft:"-1px",display:"block",whiteSpace:"pre-wrap"},".cm-diagnostic-error":{borderLeft:"5px solid #d11"},".cm-diagnostic-warning":{borderLeft:"5px solid orange"},".cm-diagnostic-info":{borderLeft:"5px solid #999"},".cm-diagnostic-hint":{borderLeft:"5px solid #66d"},".cm-diagnosticAction":{font:"inherit",border:"none",padding:"2px 4px",backgroundColor:"#444",color:"white",borderRadius:"3px",marginLeft:"8px",cursor:"pointer"},".cm-diagnosticSource":{fontSize:"70%",opacity:.7},".cm-lintRange":{backgroundPosition:"left bottom",backgroundRepeat:"repeat-x",paddingBottom:"0.7px"},".cm-lintRange-error":{backgroundImage:S("#d11")},".cm-lintRange-warning":{backgroundImage:S("orange")},".cm-lintRange-info":{backgroundImage:S("#999")},".cm-lintRange-hint":{backgroundImage:S("#66d")},".cm-lintRange-active":{backgroundColor:"#ffdd9980"},".cm-tooltip-lint":{padding:0,margin:0},".cm-lintPoint":{position:"relative","&:after":{content:'""',position:"absolute",bottom:0,left:"-2px",borderLeft:"3px solid transparent",borderRight:"3px solid transparent",borderBottom:"4px solid #d11"}},".cm-lintPoint-warning":{"&:after":{borderBottomColor:"orange"}},".cm-lintPoint-info":{"&:after":{borderBottomColor:"#999"}},".cm-lintPoint-hint":{"&:after":{borderBottomColor:"#66d"}},".cm-panel.cm-panel-lint":{position:"relative","& ul":{maxHeight:"100px",overflowY:"auto","& [aria-selected]":{backgroundColor:"#ddd","& u":{textDecoration:"underline"}},"&:focus [aria-selected]":{background_fallback:"#bdf",backgroundColor:"Highlight",color_fallback:"white",color:"HighlightText"},"& u":{textDecoration:"none"},padding:0,margin:0},"& [name=close]":{position:"absolute",top:"0",right:"2px",background:"inherit",border:"none",font:"inherit",padding:0,margin:0}}});function N(t){return t=="error"?4:t=="warning"?3:t=="info"?2:1}function U(t){let e="hint",n=1;for(let i of t){let o=N(i.severity);o>n&&(n=o,e=i.severity)}return e}const Y=[p,g.EditorView.decorations.compute([p],t=>{let{selected:e,panel:n}=t.field(p);return!e||!n||e.from==e.to?g.Decoration.none:g.Decoration.set([V.range(e.from,e.to)])}),g.hoverTooltip(z,{hideOn:$}),W];exports.closeLintPanel=P;exports.lintKeymap=_;exports.nextDiagnostic=B;exports.openLintPanel=T;exports.setDiagnosticsEffect=D;
//# sourceMappingURL=index.js.map
